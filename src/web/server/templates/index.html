{% extends "layout.html" %}

{% block title %}PPO+LSTM Implementation Demo{% endblock %}

{% block content %}
<article class="bg-white shadow rounded-lg p-8 mb-8">
    <h1 class="text-3xl font-bold mb-6">PPO+LSTM Implementation & Experiments</h1>
    
    <div class="bg-gray-50 border-l-4 border-blue-500 p-4 mb-8">
        <p class="text-lg"><strong>TLDR:</strong> I implemented PPO+LSTM from scratch and got it to solve three increasingly complex tasks: cartpole without velocity information, a memory-based navigation task, and finally a partially observable maze where the agent can only see a 3x3 area around itself, achieving an 80% success rate on 13x13 mazes with time limit 256 steps.</p>
    </div>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">History</h2>
        <p class="text-gray-600 mb-6">On April 13th, 2019, OpenAI's Dota 2 AI system, OpenAI Five, became the first AI to beat a world champion team in an esports game. The algorithm behind this was proximal policy optimization(PPO) with LSTMs, which, given enough compute (a few thousand years of self-play), enabled it to achieve superhuman performance.</p>
        
        <p class="text-gray-600 mb-6">Inspired by this, I decided to implement it too. I've linked some blogs at the end of the post if you are interested in this.</p>
        
        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: You can play all the games below on this Google Colab (in the browser). You can also try some below, but the server latency varies.</p>
        </div>
        
        <p class="text-gray-600 mb-6">All the code for this project can be found in <a href="https://github.com/RaresFelix/ppo_lstm" class="text-blue-600 hover:underline">this GitHub repo</a>.</p>
    </section>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Architecture</h2>
        
        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add classic image of agent system interaction loop</p>
        </div>
        
        <p class="text-gray-600 mb-6">For each environment, the agent receives an observation in the form of an array of numbers, and has to take an action.</p>
        
        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add image of GUI vs agent observation</p>
        </div>

        <p class="text-gray-600 mb-6">For the agent to be able to form long-term connections, I used an LSTM (long short-term memory). It's a type of recurrent neural network that can handle longer term dependencies well. Chris Olah has a very good article on how LSTMs work here.</p>

        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add image of observation + lstm -> hidden states / features</p>
        </div>

        <p class="text-gray-600 mb-6">These hidden states / features act as memory for the agent.</p>

        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add image of features going into agent heads</p>
        </div>

        <p class="text-gray-600 mb-6">These can be used by the actor head to predict the best action, or by the critic head to predict "how good" the current state is (this is very useful during training).</p>
    </section>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Example 1: Cartpole without velocities</h2>
        
        <p class="text-gray-600 mb-6">Cartpole is a classic reinforcement learning environment. The agent can see the position, angle, speed and angular velocity of a pole, and has to balance it for as long as possible.</p>
        
        <p class="text-gray-600 mb-6">You can play it yourself below. The interesting thing about it is that the human brain doesn't receive the velocities of the pole either. Using recurrent biological circuitry, your brain finds the velocities and approximates an algorithm for solving the problem.</p>

        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add Weights & Biases training graph</p>
        </div>

        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add visualization of Cartpole without speed, memory heatmap, and playable demo</p>
        </div>
    </section>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Example 2: Minigrid Memory</h2>
        
        <p class="text-gray-600 mb-6">This is a demonstration of longer-term memory capabilities. The agent can see only the 3 x 3 area around him, and has to remember which object to select at the end of the hallway. You can see it's memory in time below.</p>

        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add Weights & Biases training graphs</p>
        </div>

        <div class="bg-red-100 border-l-4 border-red-500 p-4 mb-6">
            <p class="text-red-700">TODO: Add visualization of minigrid memory with LSTM heatmap and slider</p>
        </div>
    </section>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Example 3: Minigrid Custom Maze</h2>
        
        <p class="text-gray-600 mb-6">This is a custom minigrid env I wrote for this project. The mazes are generated with Kruskal's algorithm.</p>
    </section>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Interactive Demo</h2>
        <p class="text-gray-600 mb-6">Try out the trained agent in a partially observable maze environment. The agent can only see a 3x3 area around itself.</p>
        
        <div class="bg-gray-50 p-6 rounded-lg">
            {% if error %}
                <div class="text-red-500 mb-4">{{ error }}</div>
            {% endif %}
            <div class="game-container">
                <div class="flex flex-col items-center">
                    <div class="mb-4">
                        <label class="inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="viewToggle" class="sr-only peer">
                            <div class="relative w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                            <span class="ml-3 text-sm font-medium text-gray-900">Agent View</span>
                        </label>
                    </div>
                    <canvas id="gameCanvas" 
                            width="{{ render_width if render_width else 400 }}" 
                            height="{{ render_height if render_height else 400 }}" 
                            class="border border-gray-300">
                    </canvas>
                    <div class="flex justify-center space-x-4 mt-4">
                        <button data-action="0" class="action-btn px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">↺ (A)</button>
                        <button data-action="2" class="action-btn px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">↑ (W)</button>
                        <button data-action="1" class="action-btn px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">↻ (D)</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section class="mb-12">
        <h2 class="text-2xl font-bold mb-4">Agent Analysis</h2>
        <p class="text-gray-600 mb-6">Visualize the agent's memory and decision-making process across different runs.</p>
        
        <div class="bg-gray-50 p-6 rounded-lg">
            <!-- New Visualization Section -->
            <div class="bg-white shadow rounded-lg p-4 mt-6">
                <h2 class="text-xl font-bold mb-3">Agent Visualization</h2>
                
                <!-- Modified Run Navigation to use flex container for vertical alignment -->
                <div class="flex items-stretch justify-between relative">
                    <button id="prevRun" class="text-6xl font-bold text-[#da7756] px-4 hover:bg-gray-100 flex items-center">&lt;</button>
                    
                    <div class="flex-1">
                        <!-- Visualization container -->
                        <div class="flex flex-col lg:flex-row justify-center items-center gap-4 lg:gap-0 max-w-[800px] mx-auto">
                            <!-- Maze View Container -->
                            <div class="relative w-fit shrink-0">
                                <div class="p-[4%] rounded-xl" style="background-color: #da7756;">
                                    <div class="bg-white">
                                        <img id="mazeFrame" class="w-full h-full object-contain aspect-square max-w-[350px]" src="" alt="Maze View">
                                    </div>
                                </div>
                            </div>

                            <!-- Adaptive Connecting Line -->
                            <div class="hidden lg:flex self-center h-2.5 connecting-line shrink-0" 
                                 style="background-color: #da7756; width: clamp(2rem, 5vw, 4rem); margin: 0 -2px;">
                            </div>

                            <!-- Memory Heatmap Container -->
                            <div class="relative w-fit shrink-0">
                                <div class="p-[4%] rounded-xl" style="background-color: #da7756;">
                                    <div class="bg-white">
                                        <img id="memoryHeatmap" class="w-full h-full object-contain aspect-square max-w-[220px]" src="" alt="Memory Heatmap">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="nextRun" class="text-6xl font-bold text-[#da7756] px-4 hover:bg-gray-100 flex items-center">&gt;</button>
                </div>

                <!-- Run info and frame controls -->
                <div class="mt-4 max-w-xl mx-auto text-center">
                    <div id="runInfo" class="text-sm text-gray-600 mb-2"></div>
                    <input 
                        type="range" 
                        id="frameSlider" 
                        class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-[#da7756]"
                        min="0" 
                        value="0"
                    >
                    <div class="text-center mt-2">
                        Frame: <span id="frameNumber">0</span> / <span id="maxFrame">0</span>
                    </div>
                </div>
            </div>
        </div>
    </section>
</article>

<style>
    @media (min-width: 1024px) {
        .connecting-line {
            display: flex !important;
        }
    }
    @media (max-width: 1023px) {
        .connecting-line {
            display: none !important;
        }
    }
</style>

<script src="{{ url_for('static', filename='js/game.js') }}"></script>
<script>
{% if game_render %}
displayGame({{ game_render | tojson }});
{% endif %}
</script>
{% endblock %}
